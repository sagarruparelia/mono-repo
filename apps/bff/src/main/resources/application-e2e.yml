# =============================================================================
# E2E Test Profile Configuration
# Used for Docker-based end-to-end testing of both ALB authentication flows
# =============================================================================

spring:
  # Enable Redis session for E2E testing
  session:
    store-type: redis

  # Override OAuth2 with mock values for E2E testing
  security:
    oauth2:
      client:
        registration:
          hsid:
            client-id: "e2e-client"
          external-api:
            client-id: "e2e-external-client"
            client-secret: "e2e-secret"
            authorization-grant-type: client_credentials
            scope: openid
          ecdh-api:
            client-id: "e2e-ecdh-client"
            client-secret: "e2e-secret"
            authorization-grant-type: client_credentials
            scope: openid,health.read
        provider:
          hsid:
            issuer-uri: http://mock-idp
            authorization-uri: http://mock-idp/authorize
            token-uri: http://mock-idp/token
            jwk-set-uri: http://mock-idp/.well-known/jwks.json
            user-info-uri: http://mock-idp/userinfo
          external-api:
            token-uri: http://mock-idp/token
          ecdh-api:
            token-uri: http://mock-idp/token

  # Disable OAuth2 Resource Server for E2E (no JWT validation needed)
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration

  # Optional config imports
  config:
    import:
      - optional:classpath:config/security-paths.yml
      - optional:classpath:config/rate-limiting.yml
      - optional:classpath:config/zero-trust.yml

# Security paths for E2E
security:
  paths:
    public:
      - pattern: "/actuator/**"
        description: "Actuator endpoints"
      - pattern: "/api/auth/**"
        description: "Auth endpoints"

# Disable rate limiting
rate-limiting:
  enabled: false

# Disable audit logging
zero-trust:
  audit:
    enabled: false

# App configuration
app:
  # Disable OAuth2 security filter for E2E testing
  security:
    oauth2:
      enabled: false

  session:
    timeout: 30m
    binding:
      enabled: false

  persona:
    hsid:
      claim-name: persona
      allowed:
        - individual
        - parent
    proxy:
      allowed:
        - agent
        - config
        - case_worker

  mfe:
    proxy:
      enabled: true
      headers:
        auth-type: X-Auth-Type
        partner-id: X-Partner-Id
        enterprise-id: X-Enterprise-Id
        logged-in-member-persona: X-Logged-In-Member-Persona
        logged-in-member-id-value: X-Logged-In-Member-Id-Value
        logged-in-member-id-type: X-Logged-In-Member-Id-Type
        correlation-id: X-Correlation-Id

  # Enable authorization (required by DocumentController)
  authz:
    enabled: true
    permissions-api:
      url: http://mock-permissions:8082
      timeout: 5s

  # External Integration (mTLS ALB simulation) - ENABLED for E2E testing
  external-integration:
    enabled: true
    headers:
      enterprise-id: X-Enterprise-Id
      logged-in-member-id-value: X-Logged-In-Member-Id-Value
      logged-in-member-id-type: X-Logged-In-Member-Id-Type
      logged-in-member-persona: X-Logged-In-Member-Persona
      client-id: X-Client-Id
    allowed-personas:
      - Agent
      - ConfigSpecialist
      - CaseWorker
    trusted-idp-types:
      - OHID
      - MSID

  # External API configuration for E2E testing (mock endpoints)
  external-api:
    base-url: http://mock-idp
    user-service:
      path: /api/identity/user/individual/v1/read
      timeout: 5s
    eligibility:
      path: /graph/1.0.0
      timeout: 5s
    permissions:
      path: /api/consumer/prefs/del-gr/1.0.0
      timeout: 5s
    retry:
      max-attempts: 3
      initial-backoff: 100ms
      max-backoff: 1s

# Actuator - expose all for E2E debugging
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
  health:
    # Disable non-critical health indicators for E2E testing
    s3:
      enabled: false
    permissionsApi:
      enabled: false

  # Disable tracing for E2E (no OTLP collector)
  tracing:
    enabled: false
