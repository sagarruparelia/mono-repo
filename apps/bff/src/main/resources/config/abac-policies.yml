# ABAC Policy Definitions
# Config-driven policies replace hardcoded Java classes
# Each policy defines: conditions to match, permissions required, and decision logic

abac:
  # Resource sensitivity defaults
  resource-defaults:
    # Documents are always SENSITIVE in MVP (post-MVP: per-document flag)
    document:
      default-sensitivity: SENSITIVE
    # Health resources are NON-SENSITIVE by default
    # Business can override per subcategory via subcategory-overrides
    health_summary:
      default-sensitivity: NORMAL
      # Example: uncomment to mark specific subcategories as sensitive
      # subcategory-overrides:
      #   lab_reports: SENSITIVE
      #   medication: SENSITIVE
    profile:
      default-sensitivity: NORMAL

  policies:
    # HSID Policies
    - id: HSID_VIEW_DEPENDENT
      description: "HSID parent can view dependent with DAA + RPR permissions"
      priority: 100
      conditions:
        auth-type: HSID
        resource-type: dependent
        action: VIEW
        sensitive: false
      required-permissions: [DAA, RPR]

    - id: HSID_VIEW_SENSITIVE
      description: "HSID parent can view sensitive dependent data with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        resource-type: dependent
        action: [VIEW, VIEW_SENSITIVE]
        sensitive: true
      required-permissions: [DAA, RPR, ROI]

    # Parent Document Policies
    - id: PARENT_VIEW_DOCUMENT
      description: "Parent can view youth's documents with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: document
        action: [VIEW, VIEW_SENSITIVE, LIST]
      required-permissions: [DAA, RPR, ROI]

    - id: PARENT_UPLOAD_DOCUMENT
      description: "Parent can upload documents for youth with DAA + RPR (no edit/delete)"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: document
        action: UPLOAD
      required-permissions: [DAA, RPR]

    # Youth Document Policy
    - id: YOUTH_OWNER_DOCUMENT
      description: "Youth (individual) can fully manage their own documents"
      priority: 150  # Higher priority - owner check first
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: document
      owner-check: true  # Subject userId must match resource ownerId

    # Proxy Policies
    - id: PROXY_VIEW_MEMBER
      description: "Proxy user can view assigned member or config can view any member"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: [member, dependent]
        action: VIEW
        sensitive: false
      proxy-rules:
        config-full-access: true
        require-assignment: true

    - id: PROXY_VIEW_SENSITIVE
      description: "Only config persona can view sensitive member data"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: [member, dependent]
        action: [VIEW, VIEW_SENSITIVE]
        sensitive: true
      proxy-rules:
        config-only: true

    - id: PROXY_DOCUMENT
      description: "Proxy users can access documents for assigned members"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: document
      proxy-rules:
        config-full-access: true
        require-assignment: true

    # ============================================
    # Health Summary Policies (Dual Auth)
    # ============================================

    # Member (individual) viewing own health summary
    - id: HSID_INDIVIDUAL_HEALTH
      description: "Member can view own health summary"
      priority: 150
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: health_summary
        action: VIEW
      owner-check: true

    # ResponsibleParty (parent) viewing dependent's non-sensitive health data
    - id: HSID_PARENT_HEALTH
      description: "Parent can view dependent's health summary with DAA + RPR"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: health_summary
        action: VIEW
        sensitive: false
      required-permissions: [DAA, RPR]

    # ResponsibleParty (parent) viewing dependent's sensitive health data
    - id: HSID_PARENT_HEALTH_SENSITIVE
      description: "Parent can view dependent's sensitive health data with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: health_summary
        action: VIEW
        sensitive: true
      required-permissions: [DAA, RPR, ROI]

    # Proxy users viewing non-sensitive health data
    - id: PROXY_HEALTH_SUMMARY
      description: "Proxy users can view assigned member's health summary"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: health_summary
        action: VIEW
        sensitive: false
      proxy-rules:
        config-full-access: true
        require-assignment: true

    # Only config can view sensitive health data via proxy
    - id: PROXY_HEALTH_SENSITIVE
      description: "Only config persona can view sensitive health data via proxy"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: health_summary
        action: VIEW
        sensitive: true
      proxy-rules:
        config-only: true

    # ============================================
    # Profile Policies (Dual Auth)
    # ============================================

    # Member (individual) managing own profile
    - id: HSID_INDIVIDUAL_PROFILE
      description: "Member can view and edit own profile"
      priority: 150
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: profile
      owner-check: true

    # ResponsibleParty (parent) viewing dependent's profile
    - id: HSID_PARENT_PROFILE
      description: "Parent can view dependent's profile with DAA + RPR"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: profile
        action: VIEW
      required-permissions: [DAA, RPR]

    # Proxy users viewing member's profile
    - id: PROXY_PROFILE
      description: "Proxy users can view assigned member's profile"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: profile
        action: VIEW
      proxy-rules:
        config-full-access: true
        require-assignment: true
