# ABAC Policy Definitions
# Config-driven policies replace hardcoded Java classes
# Each policy defines: conditions to match, permissions required, and decision logic

abac:
  # Resource sensitivity defaults
  resource-defaults:
    # Documents are always SENSITIVE in MVP (post-MVP: per-document flag)
    document:
      default-sensitivity: SENSITIVE
    # Health resources are SENSITIVE by default (immunizations, allergies, conditions)
    # Business can override per subcategory via subcategory-overrides
    HEALTH_DATA:
      default-sensitivity: SENSITIVE
      # Example: uncomment to mark specific subcategories as non-sensitive
      # subcategory-overrides:
      #   basic_info: NORMAL
    profile:
      default-sensitivity: NORMAL

  policies:
    # HSID Policies
    - id: HSID_VIEW_DEPENDENT
      description: "HSID parent can view dependent with DAA + RPR permissions"
      priority: 100
      conditions:
        auth-type: HSID
        resource-type: dependent
        action: VIEW
        sensitive: false
      required-permissions: [DAA, RPR]

    - id: HSID_VIEW_SENSITIVE
      description: "HSID parent can view sensitive dependent data with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        resource-type: dependent
        action: [VIEW, VIEW_SENSITIVE]
        sensitive: true
      required-permissions: [DAA, RPR, ROI]

    # Parent Document Policies
    - id: PARENT_VIEW_DOCUMENT
      description: "Parent can view youth's documents with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: document
        action: [VIEW, VIEW_SENSITIVE, LIST]
      required-permissions: [DAA, RPR, ROI]

    - id: PARENT_UPLOAD_DOCUMENT
      description: "Parent can upload documents for youth with DAA + RPR (no edit/delete)"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: document
        action: UPLOAD
      required-permissions: [DAA, RPR]

    # Youth Document Policy
    - id: YOUTH_OWNER_DOCUMENT
      description: "Youth (individual) can fully manage their own documents"
      priority: 150  # Higher priority - owner check first
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: document
      owner-check: true  # Subject userId must match resource ownerId

    # Proxy Policies
    - id: PROXY_VIEW_MEMBER
      description: "Proxy user can view assigned member or config can view any member"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: [member, dependent]
        action: VIEW
        sensitive: false
      proxy-rules:
        config-full-access: true
        require-assignment: true

    - id: PROXY_VIEW_SENSITIVE
      description: "Only config persona can view sensitive member data"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: [member, dependent]
        action: [VIEW, VIEW_SENSITIVE]
        sensitive: true
      proxy-rules:
        config-only: true

    - id: PROXY_DOCUMENT
      description: "Proxy users can access documents for assigned members"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: document
      proxy-rules:
        config-full-access: true
        require-assignment: true

    # ============================================
    # Health Data Policies (Dual Auth)
    # ============================================

    # Member (individual) viewing own health data
    - id: HSID_INDIVIDUAL_HEALTH
      description: "Member can view own health data (immunizations, allergies, conditions)"
      priority: 150
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: HEALTH_DATA
        action: VIEW
      owner-check: true

    # ResponsibleParty (parent) viewing dependent's health data
    # Since health data is always SENSITIVE, requires DAA + RPR + ROI
    - id: HSID_PARENT_HEALTH
      description: "Parent can view dependent's health data with DAA + RPR + ROI"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: HEALTH_DATA
        action: VIEW
      required-permissions: [DAA, RPR, ROI]

    # Note: PROXY auth type skips ABAC - authorization delegated to consumer
    # The following policies are kept for future use if proxy ABAC is enabled

    # Proxy users viewing health data (currently disabled - authZ delegated to consumer)
    # Uncomment if proxy ABAC enforcement is needed
    # - id: PROXY_HEALTH_DATA
    #   description: "Proxy users can view assigned member's health data"
    #   priority: 100
    #   conditions:
    #     auth-type: PROXY
    #     resource-type: HEALTH_DATA
    #     action: VIEW
    #   proxy-rules:
    #     config-full-access: true
    #     require-assignment: true

    # ============================================
    # Profile Policies (Dual Auth)
    # ============================================

    # Member (individual) managing own profile
    - id: HSID_INDIVIDUAL_PROFILE
      description: "Member can view and edit own profile"
      priority: 150
      conditions:
        auth-type: HSID
        persona: individual
        resource-type: profile
      owner-check: true

    # ResponsibleParty (parent) viewing dependent's profile
    - id: HSID_PARENT_PROFILE
      description: "Parent can view dependent's profile with DAA + RPR"
      priority: 100
      conditions:
        auth-type: HSID
        persona: parent
        resource-type: profile
        action: VIEW
      required-permissions: [DAA, RPR]

    # Proxy users viewing member's profile
    - id: PROXY_PROFILE
      description: "Proxy users can view assigned member's profile"
      priority: 100
      conditions:
        auth-type: PROXY
        resource-type: profile
        action: VIEW
      proxy-rules:
        config-full-access: true
        require-assignment: true
