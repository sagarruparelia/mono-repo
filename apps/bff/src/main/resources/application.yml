spring:
  application:
    name: bff
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:local}

  # Import external config files
  config:
    import:
      - classpath:config/security-paths.yml
      - classpath:config/rate-limiting.yml
      - classpath:config/zero-trust.yml

  # OAuth2 Client Configuration (HSID PKCE)
  security:
    oauth2:
      client:
        registration:
          hsid:
            client-id: ${HSID_CLIENT_ID}
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/api/auth/callback"
            scope: openid,profile,email
            client-authentication-method: none  # PKCE - no client secret
        provider:
          hsid:
            issuer-uri: ${HSID_ISSUER_URI}
            authorization-uri: ${HSID_AUTH_URI}
            token-uri: ${HSID_TOKEN_URI}
            jwk-set-uri: ${HSID_JWKS_URI}
            user-info-uri: ${HSID_USERINFO_URI}
            user-name-attribute: sub
      # Resource Server (for MFE proxy JWT validation)
      resourceserver:
        jwt:
          issuer-uri: ${OAUTH2_CC_ISSUER_URI:${HSID_ISSUER_URI}}
          audiences: bff-api

  # MongoDB (existing)
  data:
    mongodb:
      uri: ${MONGODB_URI:mongodb://localhost:27017/bff}

  # Redis/Valkey Session
  session:
    store-type: redis
    timeout: 30m
    redis:
      namespace: bff:session

  # Redis/Valkey Connection
  data.redis:
    host: ${VALKEY_HOST:localhost}
    port: ${VALKEY_PORT:6379}
    password: ${VALKEY_PASSWORD:}
    ssl:
      enabled: ${VALKEY_SSL_ENABLED:false}

server:
  port: 8080

# Actuator & Observability
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,loggers,env
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      show-components: when_authorized
      probes:
        enabled: true
    prometheus:
      enabled: true
    loggers:
      enabled: true

  # Health check groups
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true

  # Metrics configuration
  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:local}
    distribution:
      percentiles-histogram:
        http.server.requests: true
        http.client.requests: true
      percentiles:
        http.server.requests: 0.5, 0.75, 0.95, 0.99
        http.client.requests: 0.5, 0.75, 0.95, 0.99
      slo:
        http.server.requests: 50ms, 100ms, 200ms, 500ms, 1s, 5s
    enable:
      jvm: true
      process: true
      system: true
      logback: true

  # Distributed Tracing (OpenTelemetry)
  tracing:
    enabled: ${TRACING_ENABLED:true}
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:1.0}

  # OpenTelemetry OTLP exporter
  otlp:
    tracing:
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4318/v1/traces}
    metrics:
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4318/v1/metrics}

  # Observation configuration
  observations:
    http:
      server:
        requests:
          name: http.server.requests
      client:
        requests:
          name: http.client.requests

# Logging configuration
logging:
  level:
    root: INFO
    com.example.bff: ${LOG_LEVEL_APP:INFO}
    com.example.bff.observability: DEBUG
    org.springframework.security: INFO
    org.springframework.web: INFO
  pattern:
    correlation: "[${spring.application.name:},%X{traceId:-},%X{spanId:-},%X{correlationId:-}]"

# Custom application properties
app:
  session:
    timeout: 30m
    binding:
      enabled: true
      ip-address: true
      user-agent: true

  persona:
    hsid:
      claim-name: persona
      allowed:
        - individual
        - parent
      parent:
        dependents-claim: dependents
    proxy:
      allowed:
        - agent
        - config
        - case_worker

  mfe:
    proxy:
      enabled: true
      headers:
        auth-type: X-Auth-Type
        partner-id: X-Partner-Id
        member-id: X-Member-Id
        persona: X-Persona
        operator-id: X-Operator-Id
        operator-name: X-Operator-Name
        correlation-id: X-Correlation-Id

  # Authorization (AuthZ) Configuration
  authz:
    enabled: ${AUTHZ_ENABLED:true}
    permissions-api:
      url: ${PERMISSIONS_API_URL:http://localhost:8081}
      timeout: 5s
    cache:
      enabled: true
      ttl: 5m
    rules:
      view-dependent:
        required: [DAA, RPR]
      view-sensitive:
        required: [DAA, RPR, ROI]

  # External Integration (mTLS ALB for partner access)
  # Partners embed MFE components and proxy through mTLS ALB
  external-integration:
    enabled: ${EXTERNAL_INTEGRATION_ENABLED:false}
    headers:
      persona: X-Persona
      user-id: X-User-Id
      idp-type: X-IDP-Type
      client-id: X-Client-Id
    allowed-personas:
      - agent
      - config
      - case_worker
    trusted-idp-types: ${EXTERNAL_TRUSTED_IDP_TYPES:}

  # Document Management Configuration
  documents:
    s3:
      bucket-name: ${DOCUMENT_S3_BUCKET:documents-bucket}
      region: ${DOCUMENT_S3_REGION:us-east-1}
      endpoint: ${DOCUMENT_S3_ENDPOINT:}
      access-key-id: ${DOCUMENT_S3_ACCESS_KEY:}
      secret-access-key: ${DOCUMENT_S3_SECRET_KEY:}
    limits:
      max-file-size: 10485760  # 10MB
      max-files-per-member: 50
      allowed-content-types:
        - application/pdf
        - image/jpeg
        - image/png
        - application/msword
        - application/vnd.openxmlformats-officedocument.wordprocessingml.document
